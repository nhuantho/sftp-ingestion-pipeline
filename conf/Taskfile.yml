version: '3'

vars:
  AIRFLOW_VERSION: '3.1.3'
  PYTHON_VERSION: '3.12'
  AIRFLOW_UID: 50000
  IMAGE: ghcr.io/nhuantho/docker/airflow:{{.AIRFLOW_VERSION}}-python{{.PYTHON_VERSION}}
  BUILD_ARGS: --build-arg AIRFLOW_VERSION={{.AIRFLOW_VERSION}} --build-arg PYTHON_VERSION={{.PYTHON_VERSION}} --build-arg AIRFLOW_UID={{.AIRFLOW_UID}}

tasks:
  build:
    cmds:
    - pwd
    - docker build --pull {{.BUILD_ARGS}} --progress=plain --tag {{.IMAGE}} .

  push:
    cmds:
    - docker push {{.IMAGE}}

  publish:
  - task: build
  - task: push

  run:
    cmds:
    - docker run -it --rm {{.IMAGE}} bash -l
